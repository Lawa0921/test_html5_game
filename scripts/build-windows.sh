#!/bin/bash

# ä¸€éµæ‰“åŒ… Windows ç‰ˆæœ¬è…³æœ¬
# æ¡Œé¢å†’éšªè€… - Desktop RPG

set -e

echo "=================================="
echo "  æ¡Œé¢å†’éšªè€… - Windows æ‰“åŒ…å·¥å…·"
echo "=================================="
echo ""

# é¡è‰²å®šç¾©
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# æª¢æŸ¥ Node.js
echo -e "${BLUE}[1/5]${NC} æª¢æŸ¥ Node.js ç’°å¢ƒ..."
if ! command -v node &> /dev/null; then
    echo -e "${RED}éŒ¯èª¤: æœªæ‰¾åˆ° Node.js${NC}"
    exit 1
fi
NODE_VERSION=$(node --version)
echo -e "${GREEN}âœ“${NC} Node.js ç‰ˆæœ¬: $NODE_VERSION"
echo ""

# æª¢æŸ¥ä¾è³´
echo -e "${BLUE}[2/5]${NC} æª¢æŸ¥ä¾è³´é …..."
if [ ! -d "node_modules" ]; then
    echo -e "${YELLOW}âš ${NC} æœªæ‰¾åˆ° node_modules,æ­£åœ¨å®‰è£ä¾è³´..."
    npm install
else
    echo -e "${GREEN}âœ“${NC} ä¾è³´é …å·²å®‰è£"
fi
echo ""

# åŸ·è¡Œæ¸¬è©¦
echo -e "${BLUE}[3/5]${NC} åŸ·è¡Œæ¸¬è©¦..."
if npm test; then
    echo -e "${GREEN}âœ“${NC} æ‰€æœ‰æ¸¬è©¦é€šéŽ"
else
    echo -e "${RED}âœ—${NC} æ¸¬è©¦å¤±æ•—"
    read -p "æ¸¬è©¦å¤±æ•—,æ˜¯å¦ç¹¼çºŒæ‰“åŒ…? (y/N) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi
echo ""

# æ¸…ç†èˆŠçš„æ‰“åŒ…æ–‡ä»¶
echo -e "${BLUE}[4/5]${NC} æ¸…ç†èˆŠçš„æ‰“åŒ…æ–‡ä»¶..."
if [ -d "dist" ]; then
    echo "æ­£åœ¨åˆªé™¤ dist/ ç›®éŒ„..."
    rm -rf dist
    echo -e "${GREEN}âœ“${NC} æ¸…ç†å®Œæˆ"
else
    echo -e "${GREEN}âœ“${NC} ç„¡éœ€æ¸…ç†"
fi
echo ""

# é–‹å§‹æ‰“åŒ…
echo -e "${BLUE}[5/5]${NC} é–‹å§‹æ‰“åŒ… Windows ç‰ˆæœ¬..."
echo -e "${YELLOW}é€™å¯èƒ½éœ€è¦å¹¾åˆ†é˜æ™‚é–“...${NC}"
echo ""

if npm run build:win; then
    echo ""
    echo -e "${GREEN}=================================="
    echo "  æ‰“åŒ…æˆåŠŸ!"
    echo -e "==================================${NC}"
    echo ""
    echo "è¼¸å‡ºæ–‡ä»¶ä½ç½®: dist/"
    echo ""

    # åˆ—å‡ºæ‰“åŒ…å¾Œçš„æ–‡ä»¶
    if [ -d "dist" ]; then
        echo "æ‰“åŒ…æ–‡ä»¶åˆ—è¡¨:"
        ls -lh dist/ | grep -E '\.(exe|zip|7z)$' || echo "  (æ­£åœ¨ç”Ÿæˆ...)"
        echo ""

        # è¨ˆç®—ç¸½å¤§å°
        TOTAL_SIZE=$(du -sh dist/ 2>/dev/null | cut -f1)
        echo "ç¸½å¤§å°: $TOTAL_SIZE"
        echo ""

        # æŸ¥æ‰¾å¯åŸ·è¡Œæ–‡ä»¶
        PORTABLE=$(find dist/ -name "*portable*.exe" 2>/dev/null | head -n 1)
        INSTALLER=$(find dist/ -name "*.exe" ! -name "*portable*" 2>/dev/null | head -n 1)

        echo -e "${GREEN}å¯ç”¨ç‰ˆæœ¬:${NC}"
        if [ -n "$PORTABLE" ]; then
            echo "  ðŸ“¦ ç¶ è‰²ç‰ˆ (å…å®‰è£): $(basename "$PORTABLE")"
        fi
        if [ -n "$INSTALLER" ]; then
            echo "  ðŸ’¿ å®‰è£ç‰ˆ: $(basename "$INSTALLER")"
        fi
        echo ""

        echo -e "${YELLOW}æç¤º:${NC}"
        echo "  â€¢ ç¶ è‰²ç‰ˆå¯ç›´æŽ¥é‹è¡Œ,ç„¡éœ€å®‰è£"
        echo "  â€¢ å®‰è£ç‰ˆæœƒå‰µå»ºæ¡Œé¢å¿«æ·æ–¹å¼å’Œé–‹å§‹èœå–®é …ç›®"
        echo "  â€¢ å°‡ dist/ ç›®éŒ„ä¸­çš„ .exe æ–‡ä»¶è¤‡è£½åˆ° Windows é›»è…¦é‹è¡Œ"
        echo ""

        # å‰µå»º README
        cat > dist/README.txt << EOF
æ¡Œé¢å†’éšªè€… - Desktop RPG
========================

éŠæˆ²èªªæ˜Ž:
--------
é€™æ˜¯ä¸€å€‹é€æ˜Žæ¡Œé¢å¯µç‰©éŠæˆ²,è§’è‰²æœƒåœ¨ä½ çš„æ¡Œé¢ä¸Šè‡ªç”±ç§»å‹•ã€‚

å®‰è£æ–¹å¼:
--------
æ–¹å¼1 (ç¶ è‰²ç‰ˆ):
  - ç›´æŽ¥é‹è¡Œ *-portable.exe
  - ç„¡éœ€å®‰è£,å¯æ”¾åœ¨ä»»ä½•ä½ç½®

æ–¹å¼2 (å®‰è£ç‰ˆ):
  - é‹è¡Œå®‰è£ç¨‹åº .exe (éž portable ç‰ˆæœ¬)
  - æŒ‰ç…§æç¤ºå®Œæˆå®‰è£
  - å®‰è£å¾Œå¯å¾žæ¡Œé¢æˆ–é–‹å§‹èœå–®å•Ÿå‹•

éŠæˆ²æŽ§åˆ¶:
--------
â€¢ é»žæ“Š/éµç›¤è¼¸å…¥: ç²å–éŠ€å…©
â€¢ æ‹–æ›³è§’è‰²: ç§»å‹•è§’è‰²ä½ç½®
â€¢ é»žæ“Šè§’è‰²: æŸ¥çœ‹è§’è‰²è³‡è¨Š
â€¢ å³ä¸‹è§’UI: é–‹å•ŸéŠæˆ²ä»‹é¢

å¿«æ·éµ:
-------
â€¢ Ctrl+Shift+D: é¡¯ç¤º/éš±è—éŠæˆ²è¦–çª—
â€¢ Ctrl+Shift+Q: é€€å‡ºéŠæˆ²

éŠæˆ²ç‰¹è‰²:
--------
â€¢ å®Œå…¨é€æ˜ŽèƒŒæ™¯
â€¢ 10å€‹å¯è§£éŽ–è§’è‰²
â€¢ å®¶åœ’å‡ç´šç³»çµ±
â€¢ éš¨æ©Ÿå†’éšªäº‹ä»¶
â€¢ é›¢ç·šæŽ›æ©Ÿæ”¶ç›Š
â€¢ è‡ªå‹•å­˜æª”

ç³»çµ±éœ€æ±‚:
--------
â€¢ Windows 10/11 (64ä½å…ƒ)
â€¢ å»ºè­° 4GB RAM ä»¥ä¸Š

ç‰ˆæœ¬è³‡è¨Š:
--------
ç‰ˆæœ¬: 2.0.0
æ§‹å»ºæ—¥æœŸ: $(date '+%Y-%m-%d')

å•é¡Œåé¥‹:
--------
å¦‚é‡åˆ°å•é¡Œ,è«‹æŸ¥çœ‹éŒ¯èª¤æ—¥èªŒæˆ–è¯ç¹«é–‹ç™¼è€…ã€‚

ç¥éŠæˆ²æ„‰å¿«!
EOF

        echo -e "${GREEN}âœ“${NC} å·²å‰µå»º README.txt èªªæ˜Žæ–‡ä»¶"
        echo ""
    fi

    echo -e "${GREEN}æ‰“åŒ…å®Œæˆ!${NC}"
    echo "å¯ä»¥å°‡ dist/ ç›®éŒ„ä¸­çš„æ–‡ä»¶è¤‡è£½åˆ° Windows é›»è…¦åŸ·è¡Œ"

else
    echo ""
    echo -e "${RED}=================================="
    echo "  æ‰“åŒ…å¤±æ•—!"
    echo -e "==================================${NC}"
    echo ""
    echo "è«‹æŸ¥çœ‹ä¸Šæ–¹éŒ¯èª¤è¨Šæ¯"
    exit 1
fi
