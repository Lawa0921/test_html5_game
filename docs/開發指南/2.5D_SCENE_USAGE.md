# 2.5D å ´æ™¯ç³»çµ±ä½¿ç”¨æŒ‡å—

## å¿«é€Ÿé–‹å§‹

### 1. åŸºæœ¬å ´æ™¯è¨­ç½®

```javascript
const IsometricSceneManager = require('../utils/IsometricSceneManager');
const SCENE_CONFIGS = require('../data/sceneConfigs');

class LobbyScene extends Phaser.Scene {
    constructor() {
        super({ key: 'LobbyScene' });
    }

    create() {
        // 1. å‰µå»ºå ´æ™¯ç®¡ç†å™¨
        this.isoManager = new IsometricSceneManager(this);

        // 2. å¾é…ç½®è¼‰å…¥å ´æ™¯è¨­å®š
        this.isoManager.loadFromConfig(SCENE_CONFIGS.LobbyScene);

        // 3. è¼‰å…¥èƒŒæ™¯åœ–
        this.add.image(640, 360, 'lobby-background').setDepth(0);

        // 4. å‰µå»ºè§’è‰²
        this.player = this.add.sprite(640, 500, 'player');
        this.isoManager.registerCharacter(this.player, 200); // é€Ÿåº¦ 200 px/s

        // 5. å•Ÿç”¨é»æ“Šç§»å‹•
        this.isoManager.enableClickToMove(this.player, {
            onStart: () => console.log('é–‹å§‹ç§»å‹•'),
            onComplete: () => console.log('ç§»å‹•å®Œæˆ')
        });

        // 6. æ¯å¹€æ›´æ–°æ·±åº¦æ’åº
        this.events.on('update', () => {
            this.isoManager.updateDepthSorting();
        });

        // 7. å¯é¸ï¼šå•Ÿç”¨èª¿è©¦æ¨¡å¼ï¼ˆæŒ‰ D éµåˆ‡æ›ï¼‰
        this.input.keyboard.on('keydown-D', () => {
            this.isoManager.toggleDebugMode();
        });
    }
}
```

### 2. æ‰‹å‹•é…ç½®å ´æ™¯

å¦‚æœä¸ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ‰‹å‹•è¨­ç½®ï¼š

```javascript
create() {
    this.isoManager = new IsometricSceneManager(this);

    // å®šç¾©å¯è¡Œèµ°å€åŸŸ
    this.isoManager.setWalkableArea([
        { x: 150, y: 250 },
        { x: 1130, y: 250 },
        { x: 1050, y: 580 },
        { x: 230, y: 580 }
    ]);

    // æ·»åŠ éšœç¤™ç‰©
    this.isoManager.addObstacle({
        x: 400,
        y: 350,
        width: 120,
        height: 80,
        name: 'åœ“æ¡Œ'
    });

    // æ·»åŠ äº’å‹•ç‰©ä»¶
    this.isoManager.addInteractiveObject({
        x: 640,
        y: 230,
        radius: 60,
        name: 'æ«ƒå°',
        action: () => this.showCounterUI()
    });
}
```

## é€²éšä½¿ç”¨

### 1. æ·»åŠ  NPC

```javascript
create() {
    // ... å ´æ™¯ç®¡ç†å™¨åˆå§‹åŒ–

    // å‰µå»º NPC
    this.npc1 = this.add.sprite(300, 400, 'npc-waiter');
    this.isoManager.registerCharacter(this.npc1, 150);

    this.npc2 = this.add.sprite(900, 400, 'npc-chef');
    this.isoManager.registerCharacter(this.npc2, 150);

    // NPC è‡ªå‹•ç§»å‹•
    this.time.addEvent({
        delay: 3000,
        callback: () => {
            const randomX = Phaser.Math.Between(200, 1000);
            const randomY = Phaser.Math.Between(300, 550);
            this.isoManager.moveCharacterTo(this.npc1, randomX, randomY);
        },
        loop: true
    });
}
```

### 2. è§’è‰²å‹•ç•«

é¦–å…ˆå®šç¾©å‹•ç•«ï¼š

```javascript
preload() {
    // è¼‰å…¥ sprite sheet
    this.load.spritesheet('player', 'assets/sprites/player.png', {
        frameWidth: 64,
        frameHeight: 64
    });
}

create() {
    // å‰µå»ºå‹•ç•«
    this.anims.create({
        key: 'idle',
        frames: this.anims.generateFrameNumbers('player', { start: 0, end: 3 }),
        frameRate: 8,
        repeat: -1
    });

    this.anims.create({
        key: 'walk',
        frames: this.anims.generateFrameNumbers('player', { start: 4, end: 11 }),
        frameRate: 12,
        repeat: -1
    });

    // å‰µå»ºè§’è‰²ä¸¦æ’­æ”¾é–’ç½®å‹•ç•«
    this.player = this.add.sprite(640, 500, 'player');
    this.player.play('idle');

    // IsometricSceneManager æœƒè‡ªå‹•è™•ç†è¡Œèµ°/é–’ç½®å‹•ç•«åˆ‡æ›
    this.isoManager.registerCharacter(this.player, 200);
    this.isoManager.enableClickToMove(this.player);
}
```

### 3. ç¢°æ’æª¢æ¸¬

```javascript
update() {
    // æª¢æŸ¥ç©å®¶èˆ‡ NPC çš„ç¢°æ’
    if (this.isoManager.checkCollision(this.player, this.npc1, 50)) {
        console.log('èˆ‡ NPC1 ç¢°æ’ï¼');
        this.showDialogue(this.npc1);
    }
}
```

### 4. äº’å‹•ç³»çµ±

```javascript
create() {
    // ... å ´æ™¯ç®¡ç†å™¨åˆå§‹åŒ–

    // å®šç¾©äº’å‹•ç‰©ä»¶
    this.isoManager.addInteractiveObject({
        x: 640,
        y: 230,
        radius: 60,
        name: 'æ«ƒå°',
        action: () => this.showCounterUI()
    });

    this.isoManager.addInteractiveObject({
        x: 460,
        y: 390,
        radius: 50,
        name: 'åœ“æ¡Œ',
        action: () => this.showTableMenu()
    });
}

showCounterUI() {
    console.log('æ‰“é–‹æ«ƒå°ä»‹é¢');
    // é¡¯ç¤ºç®¡ç†ä»‹é¢
    this.scene.launch('CounterUIScene');
}

showTableMenu() {
    console.log('æ‰“é–‹é¤æ¡Œèœå–®');
    // é¡¯ç¤ºé¤æ¡Œé¸å–®
    this.scene.launch('TableMenuScene');
}
```

### 5. è§’è‰²æ–¹å‘

å¦‚æœéœ€è¦è§’è‰²é¢å‘ç§»å‹•æ–¹å‘ï¼š

```javascript
this.isoManager.enableClickToMove(this.player, {
    onUpdate: (character) => {
        // è¨ˆç®—ç§»å‹•æ–¹å‘
        const targetX = character.getData('targetX');
        const targetY = character.getData('targetY');

        if (targetX !== undefined) {
            // æ ¹æ“šæ–¹å‘ç¿»è½‰ sprite
            if (targetX < character.x) {
                character.setFlipX(true); // å‘å·¦
            } else {
                character.setFlipX(false); // å‘å³
            }
        }
    }
});
```

## èª¿è©¦å·¥å…·

### å•Ÿç”¨èª¿è©¦æ¨¡å¼

```javascript
// æ–¹æ³• 1ï¼šæŒ‰éµåˆ‡æ›
this.input.keyboard.on('keydown-D', () => {
    this.isoManager.toggleDebugMode();
});

// æ–¹æ³• 2ï¼šç›´æ¥å•Ÿç”¨
this.isoManager.debugMode = true;
this.isoManager.showDebug();
```

èª¿è©¦æ¨¡å¼æœƒé¡¯ç¤ºï¼š
- ğŸŸ¢ ç¶ è‰²ï¼šå¯è¡Œèµ°å€åŸŸ
- ğŸ”´ ç´…è‰²ï¼šéšœç¤™ç‰©
- ğŸ”µ è—è‰²ï¼šäº’å‹•ç‰©ä»¶ç¯„åœ

### æŸ¥çœ‹è§’è‰²ç‹€æ…‹

```javascript
// é–‹ç™¼è€…æ§åˆ¶å°
console.log('è§’è‰²ä½ç½®:', this.player.x, this.player.y);
console.log('è§’è‰²æ·±åº¦:', this.player.depth);
console.log('ç§»å‹•é€Ÿåº¦:', this.player.speed);
console.log('è¨»å†Šçš„è§’è‰²æ•¸:', this.isoManager.characters.length);
```

## æ•ˆèƒ½å„ªåŒ–

### 1. é™åˆ¶æ›´æ–°ç¯„åœ

åªæ›´æ–°è¢å¹•å…§çš„è§’è‰²ï¼š

```javascript
update() {
    const camera = this.cameras.main;
    const visibleCharacters = this.isoManager.characters.filter(char => {
        return camera.worldView.contains(char.x, char.y);
    });

    visibleCharacters.forEach(char => {
        char.depth = char.y;
    });
}
```

### 2. ä½¿ç”¨ç‰©ä»¶æ± 

å°æ–¼å¤§é‡ NPCï¼š

```javascript
create() {
    // å‰µå»º NPC æ± 
    this.npcPool = this.add.group({
        classType: Phaser.GameObjects.Sprite,
        maxSize: 20,
        runChildUpdate: false
    });

    // å¾æ± ä¸­ç²å– NPC
    const npc = this.npcPool.get(300, 400, 'npc');
    if (npc) {
        npc.setActive(true);
        npc.setVisible(true);
        this.isoManager.registerCharacter(npc, 150);
    }
}
```

## å®Œæ•´ç¯„ä¾‹

é€™è£¡æ˜¯ä¸€å€‹å®Œæ•´çš„å ´æ™¯ç¯„ä¾‹ï¼š

```javascript
const IsometricSceneManager = require('../utils/IsometricSceneManager');
const SCENE_CONFIGS = require('../data/sceneConfigs');

class LobbyScene extends Phaser.Scene {
    constructor() {
        super({ key: 'LobbyScene' });
    }

    preload() {
        // è¼‰å…¥è³‡æº
        this.load.image('lobby-background', 'assets/scenes/lobby.png');
        this.load.spritesheet('player', 'assets/sprites/player.png', {
            frameWidth: 64,
            frameHeight: 64
        });
        this.load.spritesheet('npc-waiter', 'assets/sprites/waiter.png', {
            frameWidth: 64,
            frameHeight: 64
        });
    }

    create() {
        // 1. å‰µå»ºå ´æ™¯ç®¡ç†å™¨
        this.isoManager = new IsometricSceneManager(this);
        this.isoManager.loadFromConfig(SCENE_CONFIGS.LobbyScene);

        // 2. èƒŒæ™¯
        this.add.image(640, 360, 'lobby-background').setDepth(0);

        // 3. å‰µå»ºå‹•ç•«
        this.createAnimations();

        // 4. å‰µå»ºç©å®¶
        const spawnPoint = SCENE_CONFIGS.LobbyScene.spawnPoints.player;
        this.player = this.add.sprite(spawnPoint.x, spawnPoint.y, 'player');
        this.player.play('idle');
        this.isoManager.registerCharacter(this.player, 200);

        // 5. å‰µå»º NPC
        const npcSpawn = SCENE_CONFIGS.LobbyScene.spawnPoints.npc1;
        this.waiter = this.add.sprite(npcSpawn.x, npcSpawn.y, 'npc-waiter');
        this.waiter.play('npc-idle');
        this.isoManager.registerCharacter(this.waiter, 150);

        // 6. å•Ÿç”¨é»æ“Šç§»å‹•
        this.isoManager.enableClickToMove(this.player);

        // 7. æ¯å¹€æ›´æ–°
        this.events.on('update', this.updateScene, this);

        // 8. èª¿è©¦æ¨¡å¼
        this.input.keyboard.on('keydown-D', () => {
            this.isoManager.toggleDebugMode();
        });

        // 9. UI æç¤º
        this.add.text(10, 10, 'é»æ“Šåœ°é¢ç§»å‹•\næŒ‰ D åˆ‡æ›èª¿è©¦æ¨¡å¼', {
            fontSize: '16px',
            color: '#ffffff',
            backgroundColor: '#000000',
            padding: { x: 10, y: 5 }
        }).setDepth(1000);
    }

    createAnimations() {
        // ç©å®¶å‹•ç•«
        this.anims.create({
            key: 'idle',
            frames: this.anims.generateFrameNumbers('player', { start: 0, end: 3 }),
            frameRate: 8,
            repeat: -1
        });

        this.anims.create({
            key: 'walk',
            frames: this.anims.generateFrameNumbers('player', { start: 4, end: 11 }),
            frameRate: 12,
            repeat: -1
        });

        // NPC å‹•ç•«
        this.anims.create({
            key: 'npc-idle',
            frames: this.anims.generateFrameNumbers('npc-waiter', { start: 0, end: 3 }),
            frameRate: 6,
            repeat: -1
        });
    }

    updateScene() {
        // æ›´æ–°æ·±åº¦æ’åº
        this.isoManager.updateDepthSorting();

        // æª¢æŸ¥ç¢°æ’
        if (this.isoManager.checkCollision(this.player, this.waiter, 60)) {
            // é¡¯ç¤ºå°è©±æç¤º
            if (!this.dialoguePrompt) {
                this.dialoguePrompt = this.add.text(
                    this.player.x,
                    this.player.y - 50,
                    'æŒ‰ E å°è©±',
                    {
                        fontSize: '14px',
                        color: '#ffff00',
                        backgroundColor: '#000000',
                        padding: { x: 5, y: 3 }
                    }
                ).setOrigin(0.5).setDepth(1000);
            }
        } else {
            if (this.dialoguePrompt) {
                this.dialoguePrompt.destroy();
                this.dialoguePrompt = null;
            }
        }
    }

    shutdown() {
        // æ¸…ç†è³‡æº
        this.isoManager.destroy();
        this.events.off('update', this.updateScene);
    }
}

module.exports = LobbyScene;
```

## å¸¸è¦‹å•é¡Œ

### Q: è§’è‰²ç‚ºä»€éº¼æœƒè¢«èƒŒæ™¯é®ä½ï¼Ÿ

A: ç¢ºä¿èƒŒæ™¯çš„ depth è¨­ç‚º 0ï¼Œè§’è‰²çš„ depth æœƒæ ¹æ“š Y åº§æ¨™è‡ªå‹•è¨­ç½®ï¼ˆé€šå¸¸ > 0ï¼‰ã€‚

### Q: é»æ“Šç§»å‹•æ²’æœ‰åæ‡‰ï¼Ÿ

A: æª¢æŸ¥ï¼š
1. æ˜¯å¦èª¿ç”¨äº† `enableClickToMove()`
2. ç›®æ¨™ä½ç½®æ˜¯å¦åœ¨å¯è¡Œèµ°å€åŸŸå…§ï¼ˆå•Ÿç”¨èª¿è©¦æ¨¡å¼æŸ¥çœ‹ï¼‰
3. æ˜¯å¦æ­£ç¢ºè¨­ç½®äº†å¯è¡Œèµ°å€åŸŸ

### Q: è§’è‰²ç§»å‹•é€Ÿåº¦ä¸å°ï¼Ÿ

A: èª¿æ•´ `registerCharacter()` çš„ speed åƒæ•¸ï¼ˆå–®ä½ï¼šåƒç´ /ç§’ï¼‰ã€‚

### Q: å¦‚ä½•å¯¦ç¾å¤šæ¨“å±¤ï¼Ÿ

A: ç‚ºä¸åŒæ¨“å±¤å‰µå»ºä¸åŒçš„å ´æ™¯ï¼Œä½¿ç”¨ `this.scene.start()` åˆ‡æ›ã€‚

## ä¸‹ä¸€æ­¥

- æŸ¥çœ‹ [2.5D_SCENE_IMPLEMENTATION.md](../æŠ€è¡“æ–‡æª”/2.5D_SCENE_IMPLEMENTATION.md) äº†è§£æŠ€è¡“ç´°ç¯€
- æŸ¥çœ‹ `src/data/sceneConfigs.js` æŸ¥çœ‹æ‰€æœ‰å ´æ™¯é…ç½®
- å¯¦ä½œ A* å°‹è·¯ç®—æ³•ï¼ˆPhase 2ï¼‰
