# 2.5D 場景系統使用指南

## 快速開始

### 1. 基本場景設置

```javascript
const IsometricSceneManager = require('../utils/IsometricSceneManager');
const SCENE_CONFIGS = require('../data/sceneConfigs');

class LobbyScene extends Phaser.Scene {
    constructor() {
        super({ key: 'LobbyScene' });
    }

    create() {
        // 1. 創建場景管理器
        this.isoManager = new IsometricSceneManager(this);

        // 2. 從配置載入場景設定
        this.isoManager.loadFromConfig(SCENE_CONFIGS.LobbyScene);

        // 3. 載入背景圖
        this.add.image(640, 360, 'lobby-background').setDepth(0);

        // 4. 創建角色
        this.player = this.add.sprite(640, 500, 'player');
        this.isoManager.registerCharacter(this.player, 200); // 速度 200 px/s

        // 5. 啟用點擊移動
        this.isoManager.enableClickToMove(this.player, {
            onStart: () => console.log('開始移動'),
            onComplete: () => console.log('移動完成')
        });

        // 6. 每幀更新深度排序
        this.events.on('update', () => {
            this.isoManager.updateDepthSorting();
        });

        // 7. 可選：啟用調試模式（按 D 鍵切換）
        this.input.keyboard.on('keydown-D', () => {
            this.isoManager.toggleDebugMode();
        });
    }
}
```

### 2. 手動配置場景

如果不使用配置文件，也可以手動設置：

```javascript
create() {
    this.isoManager = new IsometricSceneManager(this);

    // 定義可行走區域
    this.isoManager.setWalkableArea([
        { x: 150, y: 250 },
        { x: 1130, y: 250 },
        { x: 1050, y: 580 },
        { x: 230, y: 580 }
    ]);

    // 添加障礙物
    this.isoManager.addObstacle({
        x: 400,
        y: 350,
        width: 120,
        height: 80,
        name: '圓桌'
    });

    // 添加互動物件
    this.isoManager.addInteractiveObject({
        x: 640,
        y: 230,
        radius: 60,
        name: '櫃台',
        action: () => this.showCounterUI()
    });
}
```

## 進階使用

### 1. 添加 NPC

```javascript
create() {
    // ... 場景管理器初始化

    // 創建 NPC
    this.npc1 = this.add.sprite(300, 400, 'npc-waiter');
    this.isoManager.registerCharacter(this.npc1, 150);

    this.npc2 = this.add.sprite(900, 400, 'npc-chef');
    this.isoManager.registerCharacter(this.npc2, 150);

    // NPC 自動移動
    this.time.addEvent({
        delay: 3000,
        callback: () => {
            const randomX = Phaser.Math.Between(200, 1000);
            const randomY = Phaser.Math.Between(300, 550);
            this.isoManager.moveCharacterTo(this.npc1, randomX, randomY);
        },
        loop: true
    });
}
```

### 2. 角色動畫

首先定義動畫：

```javascript
preload() {
    // 載入 sprite sheet
    this.load.spritesheet('player', 'assets/sprites/player.png', {
        frameWidth: 64,
        frameHeight: 64
    });
}

create() {
    // 創建動畫
    this.anims.create({
        key: 'idle',
        frames: this.anims.generateFrameNumbers('player', { start: 0, end: 3 }),
        frameRate: 8,
        repeat: -1
    });

    this.anims.create({
        key: 'walk',
        frames: this.anims.generateFrameNumbers('player', { start: 4, end: 11 }),
        frameRate: 12,
        repeat: -1
    });

    // 創建角色並播放閒置動畫
    this.player = this.add.sprite(640, 500, 'player');
    this.player.play('idle');

    // IsometricSceneManager 會自動處理行走/閒置動畫切換
    this.isoManager.registerCharacter(this.player, 200);
    this.isoManager.enableClickToMove(this.player);
}
```

### 3. 碰撞檢測

```javascript
update() {
    // 檢查玩家與 NPC 的碰撞
    if (this.isoManager.checkCollision(this.player, this.npc1, 50)) {
        console.log('與 NPC1 碰撞！');
        this.showDialogue(this.npc1);
    }
}
```

### 4. 互動系統

```javascript
create() {
    // ... 場景管理器初始化

    // 定義互動物件
    this.isoManager.addInteractiveObject({
        x: 640,
        y: 230,
        radius: 60,
        name: '櫃台',
        action: () => this.showCounterUI()
    });

    this.isoManager.addInteractiveObject({
        x: 460,
        y: 390,
        radius: 50,
        name: '圓桌',
        action: () => this.showTableMenu()
    });
}

showCounterUI() {
    console.log('打開櫃台介面');
    // 顯示管理介面
    this.scene.launch('CounterUIScene');
}

showTableMenu() {
    console.log('打開餐桌菜單');
    // 顯示餐桌選單
    this.scene.launch('TableMenuScene');
}
```

### 5. 角色方向

如果需要角色面向移動方向：

```javascript
this.isoManager.enableClickToMove(this.player, {
    onUpdate: (character) => {
        // 計算移動方向
        const targetX = character.getData('targetX');
        const targetY = character.getData('targetY');

        if (targetX !== undefined) {
            // 根據方向翻轉 sprite
            if (targetX < character.x) {
                character.setFlipX(true); // 向左
            } else {
                character.setFlipX(false); // 向右
            }
        }
    }
});
```

## 調試工具

### 啟用調試模式

```javascript
// 方法 1：按鍵切換
this.input.keyboard.on('keydown-D', () => {
    this.isoManager.toggleDebugMode();
});

// 方法 2：直接啟用
this.isoManager.debugMode = true;
this.isoManager.showDebug();
```

調試模式會顯示：
- 🟢 綠色：可行走區域
- 🔴 紅色：障礙物
- 🔵 藍色：互動物件範圍

### 查看角色狀態

```javascript
// 開發者控制台
console.log('角色位置:', this.player.x, this.player.y);
console.log('角色深度:', this.player.depth);
console.log('移動速度:', this.player.speed);
console.log('註冊的角色數:', this.isoManager.characters.length);
```

## 效能優化

### 1. 限制更新範圍

只更新螢幕內的角色：

```javascript
update() {
    const camera = this.cameras.main;
    const visibleCharacters = this.isoManager.characters.filter(char => {
        return camera.worldView.contains(char.x, char.y);
    });

    visibleCharacters.forEach(char => {
        char.depth = char.y;
    });
}
```

### 2. 使用物件池

對於大量 NPC：

```javascript
create() {
    // 創建 NPC 池
    this.npcPool = this.add.group({
        classType: Phaser.GameObjects.Sprite,
        maxSize: 20,
        runChildUpdate: false
    });

    // 從池中獲取 NPC
    const npc = this.npcPool.get(300, 400, 'npc');
    if (npc) {
        npc.setActive(true);
        npc.setVisible(true);
        this.isoManager.registerCharacter(npc, 150);
    }
}
```

## 完整範例

這裡是一個完整的場景範例：

```javascript
const IsometricSceneManager = require('../utils/IsometricSceneManager');
const SCENE_CONFIGS = require('../data/sceneConfigs');

class LobbyScene extends Phaser.Scene {
    constructor() {
        super({ key: 'LobbyScene' });
    }

    preload() {
        // 載入資源
        this.load.image('lobby-background', 'assets/scenes/lobby.png');
        this.load.spritesheet('player', 'assets/sprites/player.png', {
            frameWidth: 64,
            frameHeight: 64
        });
        this.load.spritesheet('npc-waiter', 'assets/sprites/waiter.png', {
            frameWidth: 64,
            frameHeight: 64
        });
    }

    create() {
        // 1. 創建場景管理器
        this.isoManager = new IsometricSceneManager(this);
        this.isoManager.loadFromConfig(SCENE_CONFIGS.LobbyScene);

        // 2. 背景
        this.add.image(640, 360, 'lobby-background').setDepth(0);

        // 3. 創建動畫
        this.createAnimations();

        // 4. 創建玩家
        const spawnPoint = SCENE_CONFIGS.LobbyScene.spawnPoints.player;
        this.player = this.add.sprite(spawnPoint.x, spawnPoint.y, 'player');
        this.player.play('idle');
        this.isoManager.registerCharacter(this.player, 200);

        // 5. 創建 NPC
        const npcSpawn = SCENE_CONFIGS.LobbyScene.spawnPoints.npc1;
        this.waiter = this.add.sprite(npcSpawn.x, npcSpawn.y, 'npc-waiter');
        this.waiter.play('npc-idle');
        this.isoManager.registerCharacter(this.waiter, 150);

        // 6. 啟用點擊移動
        this.isoManager.enableClickToMove(this.player);

        // 7. 每幀更新
        this.events.on('update', this.updateScene, this);

        // 8. 調試模式
        this.input.keyboard.on('keydown-D', () => {
            this.isoManager.toggleDebugMode();
        });

        // 9. UI 提示
        this.add.text(10, 10, '點擊地面移動\n按 D 切換調試模式', {
            fontSize: '16px',
            color: '#ffffff',
            backgroundColor: '#000000',
            padding: { x: 10, y: 5 }
        }).setDepth(1000);
    }

    createAnimations() {
        // 玩家動畫
        this.anims.create({
            key: 'idle',
            frames: this.anims.generateFrameNumbers('player', { start: 0, end: 3 }),
            frameRate: 8,
            repeat: -1
        });

        this.anims.create({
            key: 'walk',
            frames: this.anims.generateFrameNumbers('player', { start: 4, end: 11 }),
            frameRate: 12,
            repeat: -1
        });

        // NPC 動畫
        this.anims.create({
            key: 'npc-idle',
            frames: this.anims.generateFrameNumbers('npc-waiter', { start: 0, end: 3 }),
            frameRate: 6,
            repeat: -1
        });
    }

    updateScene() {
        // 更新深度排序
        this.isoManager.updateDepthSorting();

        // 檢查碰撞
        if (this.isoManager.checkCollision(this.player, this.waiter, 60)) {
            // 顯示對話提示
            if (!this.dialoguePrompt) {
                this.dialoguePrompt = this.add.text(
                    this.player.x,
                    this.player.y - 50,
                    '按 E 對話',
                    {
                        fontSize: '14px',
                        color: '#ffff00',
                        backgroundColor: '#000000',
                        padding: { x: 5, y: 3 }
                    }
                ).setOrigin(0.5).setDepth(1000);
            }
        } else {
            if (this.dialoguePrompt) {
                this.dialoguePrompt.destroy();
                this.dialoguePrompt = null;
            }
        }
    }

    shutdown() {
        // 清理資源
        this.isoManager.destroy();
        this.events.off('update', this.updateScene);
    }
}

module.exports = LobbyScene;
```

## 常見問題

### Q: 角色為什麼會被背景遮住？

A: 確保背景的 depth 設為 0，角色的 depth 會根據 Y 座標自動設置（通常 > 0）。

### Q: 點擊移動沒有反應？

A: 檢查：
1. 是否調用了 `enableClickToMove()`
2. 目標位置是否在可行走區域內（啟用調試模式查看）
3. 是否正確設置了可行走區域

### Q: 角色移動速度不對？

A: 調整 `registerCharacter()` 的 speed 參數（單位：像素/秒）。

### Q: 如何實現多樓層？

A: 為不同樓層創建不同的場景，使用 `this.scene.start()` 切換。

## 下一步

- 查看 [2.5D_SCENE_IMPLEMENTATION.md](../技術文檔/2.5D_SCENE_IMPLEMENTATION.md) 了解技術細節
- 查看 `src/data/sceneConfigs.js` 查看所有場景配置
- 實作 A* 尋路算法（Phase 2）
