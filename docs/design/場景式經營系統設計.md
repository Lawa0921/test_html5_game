# 場景式經營系統設計文檔

## 一、遊戲核心概念

### 遊戲類型
**2.5D 場景式客棧經營掛機遊戲**
- 視角：斜向 2.5D（類似《飢荒》）
- 模式：桌面寵物 + 經營模擬
- 風格：宋朝武俠 + 客棧經營

### 雙模式設計

#### 小視窗模式（300x400）
```
┌──────────────────┐
│                  │
│   [客棧外觀]      │  ← 2.5D 斜向視角
│    🏮悅來客棧     │     會隨進度變化
│                  │
│   [門口有精靈]    │
│                  │
│ 💰 1,234  📈45/秒│
│ ⏰ 午時 (晴)     │  ← 時間顯示
└──────────────────┘
```

#### 展開模式（900x650）
```
┌────────────────────────────────────────┐
│ 🏮 悅來客棧 - 一樓大廳  ⏰ 午時三刻 (晴) │
├────────────────────────────────────────┤
│                                        │
│         [2.5D 客棧內部場景]             │
│                                        │
│   👔 掌櫃 (櫃台)    [樓梯]             │
│                                        │
│   👨‍🍳 廚師 → 廚房   [桌子] 👨‍💼服務員  │
│                                        │
│   💂 保鏢 (站崗)    [門]               │
│                                        │
│ [廚房] [客房] [後院]  ← 場景切換       │
└────────────────────────────────────────┘
```

---

## 二、核心系統架構

### 2.1 時間系統 (TimeManager)

#### 時間單位
```javascript
{
  // 天干地支紀年
  year: "開禧二年",

  // 天干紀日（60天一循環）
  day: {
    stem: "甲",  // 天干：甲乙丙丁戊己庚辛壬癸
    branch: "子", // 地支：子丑寅卯辰巳午未申酉戌亥
    count: 1      // 當前是第幾天
  },

  // 時辰系統（一天12個時辰）
  hour: {
    name: "午時",     // 子丑寅卯辰巳午未申酉戌亥
    index: 6,        // 0-11
    quarter: 2,      // 一刻、二刻、三刻、四刻
    realMinutes: 0   // 實際流逝分鐘（遊戲內1時辰 = 真實5分鐘）
  },

  // 天氣
  weather: "晴",  // 晴、陰、雨、雪

  // 季節
  season: "春"    // 春夏秋冬
}
```

#### 時辰對應表
| 時辰 | 時間 | 說明 | 遊戲狀態 |
|------|------|------|---------|
| 子時 | 23-01 | 深夜 | 休息 |
| 丑時 | 01-03 | 深夜 | 休息 |
| 寅時 | 03-05 | 黎明 | 休息 |
| 卯時 | 05-07 | 日出 | **開始營業** |
| 辰時 | 07-09 | 早晨 | 營業中 |
| 巳時 | 09-11 | 上午 | 營業中 |
| 午時 | 11-13 | 正午 | 營業中 |
| 未時 | 13-15 | 下午 | 營業中 |
| 申時 | 15-17 | 傍晚 | 營業中 |
| 酉時 | 17-19 | 日落 | 營業中 |
| 戌時 | 19-21 | 黃昏 | **打烊** |
| 亥時 | 21-23 | 夜晚 | 休息 |

#### 時間流速
- **真實時間 1 分鐘 = 遊戲內 1 時辰** （建議，可調整）
- **真實時間 12 分鐘 = 遊戲內 1 天**
- **真實時間 2 小時 = 遊戲內 10 天**

---

### 2.2 角色專長系統

#### 角色技能分類
```javascript
{
  // 基礎屬性
  name: "孟四娘",
  type: "chef",

  // 專長評級（S > A > B > C > D）
  skills: {
    cooking: "S",      // 烹飪
    service: "C",      // 服務
    combat: "B",       // 戰鬥
    medicine: "A",     // 醫療
    entertainment: "D", // 娛樂
    management: "C",   // 管理
    crafting: "B"      // 製作
  },

  // 可執行的工作類型
  canWork: [
    "kitchen",      // 廚房工作
    "lobby",        // 大廳服務（低效）
    "medicine"      // 簡單醫療
  ],

  // 工作效率加成
  workEfficiency: {
    kitchen: 2.5,   // 250% 效率
    lobby: 0.5,     // 50% 效率
    medicine: 1.5   // 150% 效率
  }
}
```

#### 10位角色專長定義

| 角色 | 烹飪 | 服務 | 戰鬥 | 醫療 | 娛樂 | 管理 | 製作 | 主要工作 |
|------|-----|------|-----|------|-----|------|-----|---------|
| 👔 掌櫃 | B | A | A | C | B | **S** | C | 管理、接待 |
| 👨‍🍳 廚師 | **S** | C | B | A | D | C | B | 烹飪、藥膳 |
| 👨‍💼 服務員 | C | **S** | D | D | A | B | D | 服務、接待 |
| 💂 保鏢 | D | D | **S** | C | C | B | C | 戰鬥、安保 |
| 🏃 跑堂 | D | A | B | D | C | C | D | 跑腿、雜務 |
| ⚗️ 藥師 | B | D | C | **S** | D | C | A | 醫療、煉藥 |
| 📖 說書人 | D | B | C | D | **S** | A | D | 娛樂、情報 |
| 🎵 樂師 | D | C | B | D | **S** | C | D | 娛樂、琴藝 |
| 📊 賬房 | C | C | D | D | D | **S** | C | 管理、算賬 |
| 🚪 門童 | D | A | C | D | B | C | D | 迎賓、雜務 |

---

### 2.3 工作調度系統 (WorkScheduler)

#### 工作崗位定義
```javascript
// 客棧可分配的工作崗位
const WORK_STATIONS = {
  lobby: {
    name: "大廳接待",
    location: { x: 200, y: 150 },  // 工作位置
    maxWorkers: 2,                 // 最多2人
    requiredSkills: ["service"],   // 需要服務技能
    workHours: [4, 19],           // 卯時到戌時
    incomeBonus: 1.2              // 收益加成
  },

  kitchen: {
    name: "廚房烹飪",
    location: { x: 100, y: 200 },
    maxWorkers: 2,
    requiredSkills: ["cooking"],
    workHours: [4, 19],
    incomeBonus: 1.5
  },

  security: {
    name: "安保巡邏",
    location: { x: 300, y: 100 },
    maxWorkers: 1,
    requiredSkills: ["combat"],
    workHours: [4, 22],  // 工作到亥時
    incomeBonus: 1.0,
    patrolPath: [...]    // 巡邏路徑
  },

  entertainment: {
    name: "大廳娛樂",
    location: { x: 250, y: 180 },
    maxWorkers: 2,
    requiredSkills: ["entertainment"],
    workHours: [11, 19], // 午時到戌時
    incomeBonus: 1.3
  },

  medicine: {
    name: "藥房",
    location: { x: 50, y: 100 },
    maxWorkers: 1,
    requiredSkills: ["medicine"],
    workHours: [7, 19],  // 辰時到戌時
    incomeBonus: 1.1
  },

  management: {
    name: "櫃台管理",
    location: { x: 200, y: 120 },
    maxWorkers: 1,
    requiredSkills: ["management"],
    workHours: [4, 19],
    incomeBonus: 1.4
  }
};
```

#### 工作狀態機
```javascript
員工狀態 {
  IDLE: "閒置",      // 無事可做
  WALKING: "移動中",  // 前往工作崗位
  WORKING: "工作中",  // 正在工作
  RESTING: "休息中",  // 工作間隙休息
  SLEEPING: "睡眠中", // 晚上睡覺
  EVENT: "事件中"    // 觸發特殊事件
}
```

#### 自動排班邏輯
```javascript
function autoSchedule(employees, currentHour) {
  // 1. 檢查時間，是否在營業時間
  if (currentHour < 4 || currentHour > 19) {
    return setAllEmployees("SLEEPING");
  }

  // 2. 優先分配核心崗位
  const priorities = [
    "management",    // 掌櫃必須有人
    "kitchen",       // 廚房必須有人
    "lobby",         // 大廳服務
    "security",      // 安保
    "entertainment", // 娛樂
    "medicine"       // 藥房
  ];

  // 3. 根據專長匹配最佳人選
  priorities.forEach(station => {
    const bestMatch = findBestEmployee(employees, station);
    assignWork(bestMatch, station);
  });

  // 4. 剩餘員工自動休息或做雜務
}
```

---

### 2.4 場景系統重構

#### 場景列表
```javascript
// 小視窗場景
ExteriorScene {
  key: "ExteriorScene",
  displayMode: "small",  // 300x400
  background: "exterior_level_1.png",  // 會根據等級變化
  interactiveArea: {
    x: 0, y: 0, width: 300, height: 350
  },
  onClick: () => expandToInterior()
}

// 展開場景 - 一樓大廳
LobbyScene {
  key: "LobbyScene",
  displayMode: "large",  // 900x650
  background: "lobby_interior.png",

  // 可交互區域
  hotspots: [
    {
      id: "counter",
      name: "櫃台",
      bounds: { x: 200, y: 120, width: 100, height: 80 },
      onClick: () => showCounterMenu()
    },
    {
      id: "kitchen_door",
      name: "廚房入口",
      bounds: { x: 50, y: 180, width: 60, height: 80 },
      onClick: () => switchToScene("KitchenScene")
    },
    {
      id: "stairs",
      name: "樓梯",
      bounds: { x: 700, y: 100, width: 80, height: 150 },
      onClick: () => switchToScene("SecondFloorScene")
    }
  ],

  // 角色生成點
  spawnPoints: {
    manager: { x: 220, y: 130 },
    waiter: { x: 300, y: 200 },
    guard: { x: 400, y: 150 }
  }
}

// 其他場景
KitchenScene      // 廚房
RoomScene         // 客房區
YardScene         // 後院
SecondFloorScene  // 二樓
```

---

### 2.5 角色移動系統

#### Sprite 管理
```javascript
class CharacterSprite {
  constructor(scene, character, x, y) {
    this.scene = scene;
    this.character = character;  // 引用 GameState 中的角色數據

    // 創建精靈（目前用佔位圖）
    this.sprite = scene.add.sprite(x, y, 'character_placeholder');
    this.sprite.setOrigin(0.5, 1);  // 底部中心為錨點

    // 顯示名字
    this.nameText = scene.add.text(x, y - 60, character.name, {
      fontSize: '12px',
      color: '#ffffff',
      backgroundColor: '#000000',
      padding: { x: 4, y: 2 }
    }).setOrigin(0.5);

    // 狀態指示器
    this.statusIcon = scene.add.sprite(x + 20, y - 50, 'status_working');

    // 當前狀態
    this.currentState = "IDLE";
    this.targetPosition = null;
    this.workStation = null;
  }

  // 移動到目標位置
  moveTo(x, y, callback) {
    this.currentState = "WALKING";
    this.targetPosition = { x, y };

    // 使用 Tween 移動
    this.scene.tweens.add({
      targets: [this.sprite, this.nameText, this.statusIcon],
      x: x,
      y: y,
      duration: 2000,
      ease: 'Linear',
      onComplete: () => {
        this.currentState = "IDLE";
        if (callback) callback();
      }
    });
  }

  // 開始工作
  startWork(station) {
    this.workStation = station;
    this.currentState = "WORKING";
    this.statusIcon.setTexture('status_working');

    // 播放工作動畫（待實現）
    this.playAnimation('work_' + station.type);
  }

  // 休息
  rest() {
    this.currentState = "RESTING";
    this.statusIcon.setTexture('status_resting');
    this.playAnimation('idle');
  }

  // 睡覺
  sleep() {
    this.currentState = "SLEEPING";
    this.statusIcon.setTexture('status_sleeping');
    this.sprite.setAlpha(0.5);  // 半透明表示睡眠
  }

  update(delta) {
    // 更新邏輯（動畫播放等）
  }
}
```

#### 移動模式
```javascript
// 混合模式：重要時刻走動，平時固定
const MovementMode = {
  STATIC: "static",         // 靜態站位（大部分時間）
  PATROL: "patrol",         // 巡邏路線（保鏢）
  EVENT_DRIVEN: "event"     // 事件觸發移動
};

// 觸發移動的事件
const MovementEvents = [
  "上班",     // 從休息區走到工作崗位
  "下班",     // 從工作崗位走回休息區
  "吃飯",     // 去廚房
  "客人來訪", // 服務員迎接客人
  "隨機事件"  // 山賊來襲等
];
```

---

## 三、數據結構設計

### 3.1 GameState 擴展
```javascript
class GameState {
  constructor() {
    // ... 現有屬性 ...

    // 新增：時間系統
    this.time = {
      year: "開禧二年",
      day: { stem: "甲", branch: "子", count: 1 },
      hour: { name: "卯時", index: 4, quarter: 0 },
      weather: "晴",
      season: "春"
    };

    // 新增：工作調度
    this.workSchedule = {
      lobby: [],      // 分配到大廳的員工ID
      kitchen: [],    // 分配到廚房的員工ID
      security: [],   // 分配到安保的員工ID
      entertainment: [],
      medicine: [],
      management: []
  };

    // 新增：場景狀態
    this.currentScene = "ExteriorScene";
    this.sceneData = {
      lobbyLevel: 1,      // 大廳等級（影響背景圖）
      kitchenLevel: 1,
      exteriorLevel: 1
    };

    // 修改：員工數據（增加專長和狀態）
    this.employees = this.initializeEmployeesWithSkills();
  }

  initializeEmployeesWithSkills() {
    return [
      {
        id: 0,
        name: '掌櫃',
        type: 'manager',
        unlocked: true,
        level: 1,

        // 新增：專長
        skills: {
          cooking: "B",
          service: "A",
          combat: "A",
          medicine: "C",
          entertainment: "B",
          management: "S",
          crafting: "C"
        },

        // 新增：工作狀態
        workStatus: {
          currentState: "IDLE",      // IDLE/WORKING/RESTING/SLEEPING
          assignedStation: "management",
          position: { x: 220, y: 130 },
          lastWorkTime: 0
        },

        // 新增：工作偏好
        preferredWork: ["management", "lobby"],

        // 原有屬性
        description: '客棧的管理者，提升總體收入',
        incomeBonus: 0.1,
        unlockCost: 0,
        upgradeCost: 100
      },
      // ... 其他9個員工 ...
    ];
  }

  // 新增方法：分配工作
  assignWork(employeeId, stationId) {
    const employee = this.employees.find(e => e.id === employeeId);
    const station = WORK_STATIONS[stationId];

    // 檢查是否有該技能
    const requiredSkill = station.requiredSkills[0];
    const skillLevel = employee.skills[requiredSkill];

    if (skillLevel === "D" || !skillLevel) {
      return { success: false, message: "該員工不適合此工作" };
    }

    // 檢查崗位是否已滿
    if (this.workSchedule[stationId].length >= station.maxWorkers) {
      return { success: false, message: "工作崗位已滿" };
    }

    // 分配工作
    employee.workStatus.assignedStation = stationId;
    this.workSchedule[stationId].push(employeeId);

    return { success: true, message: `${employee.name}已分配到${station.name}` };
  }

  // 新增方法：計算工作效率
  calculateWorkEfficiency(employeeId) {
    const employee = this.employees.find(e => e.id === employeeId);
    const station = employee.workStatus.assignedStation;

    if (!station) return 1.0;

    const requiredSkill = WORK_STATIONS[station].requiredSkills[0];
    const skillLevel = employee.skills[requiredSkill];

    // 技能等級轉換為效率加成
    const efficiencyMap = {
      "S": 2.5,
      "A": 2.0,
      "B": 1.5,
      "C": 1.0,
      "D": 0.5
    };

    return efficiencyMap[skillLevel] || 1.0;
  }
}
```

---

## 四、視覺資產需求

### 4.1 客棧外觀（小視窗背景）
```
需要素材：
- exterior_level_1.png (初期：簡陋小客棧)
- exterior_level_2.png (3個夥伴：增加招牌)
- exterior_level_3.png (5個夥伴：二層樓)
- exterior_level_4.png (7個夥伴：三層樓)
- exterior_level_5.png (10個夥伴：豪華客棧)

尺寸：300x350
視角：斜向45度
風格：宋朝建築 + 2.5D
```

### 4.2 客棧內部場景
```
需要素材：
- lobby_interior.png (一樓大廳)
- kitchen_interior.png (廚房)
- room_interior.png (客房區)
- yard_interior.png (後院)
- floor2_interior.png (二樓)

尺寸：900x550
視角：斜向45度
包含：
- 櫃台、桌椅、樓梯等固定物件
- 熱區標記（可點擊區域）
```

### 4.3 角色精靈圖
```
需要素材（每個角色）：
- character_name_idle.png (待機動畫，4幀)
- character_name_walk_down.png (向下走，4幀)
- character_name_walk_up.png (向上走，4幀)
- character_name_walk_left.png (向左走，4幀)
- character_name_walk_right.png (向右走，4幀)
- character_name_work.png (工作動畫，4幀)

尺寸：64x64 每幀
數量：10個角色 × 6種動畫 = 60個精靈表
```

### 4.4 UI 圖標
```
需要素材：
- status_working.png (工作中圖標)
- status_resting.png (休息中圖標)
- status_sleeping.png (睡眠中圖標)
- time_sun.png (太陽圖標)
- time_moon.png (月亮圖標)
- weather_icons.png (晴雨雪等)
```

### 4.5 佔位圖方案
```
在素材生成前，先用簡單圖形代替：
- 背景：純色 + 網格線
- 角色：帶名字的圓形
- 圖標：emoji 或文字

這樣可以先實現邏輯，之後快速替換素材
```

---

## 五、實現優先級

### Phase 1：核心系統（本週）
✅ 1. 時間管理器 (TimeManager)
✅ 2. 更新 GameState（角色專長、工作狀態）
✅ 3. 工作調度系統 (WorkScheduler)
✅ 4. 用佔位圖測試邏輯

### Phase 2：場景重構（下週）
⏳ 5. ExteriorScene（客棧外觀，小視窗）
⏳ 6. LobbyScene（一樓大廳，展開視窗）
⏳ 7. 角色精靈系統（靜態站位 + 簡單移動）
⏳ 8. 場景切換邏輯

### Phase 3：進階功能（第三週）
⏳ 9. 其他場景（廚房、客房等）
⏳ 10. 精靈動畫系統
⏳ 11. 天氣、季節變化
⏳ 12. 隨機事件場景化

### Phase 4：素材整合（第四週）
⏳ 13. 替換所有佔位圖為正式素材
⏳ 14. 動畫打磨
⏳ 15. 音效、BGM
⏳ 16. 最終測試

---

## 六、技術要點

### 6.1 時間流速控制
```javascript
class TimeManager {
  constructor() {
    this.timeScale = 1.0;  // 時間倍速（可調整）
    this.realTimePerHour = 60000;  // 真實1分鐘 = 遊戲1時辰
  }

  // 暫停時間
  pause() { this.timeScale = 0; }

  // 加速時間（掛機時）
  speedUp(scale) { this.timeScale = scale; }

  // 恢復正常速度
  normal() { this.timeScale = 1.0; }
}
```

### 6.2 角色 AI 簡化版
```javascript
// 員工不需要複雜 AI，只需要狀態機
class EmployeeAI {
  update(employee, currentHour) {
    // 1. 檢查時間，該睡覺了嗎？
    if (currentHour < 4 || currentHour > 21) {
      return "SLEEPING";
    }

    // 2. 有分配工作嗎？
    if (employee.workStatus.assignedStation) {
      const station = WORK_STATIONS[employee.workStatus.assignedStation];

      // 3. 在工作時間內嗎？
      if (currentHour >= station.workHours[0] &&
          currentHour <= station.workHours[1]) {
        return "WORKING";
      }
    }

    // 4. 其他時間休息
    return "RESTING";
  }
}
```

### 6.3 場景切換動畫
```javascript
switchToScene(newSceneKey) {
  // 淡出當前場景
  this.cameras.main.fadeOut(300, 0, 0, 0);

  this.cameras.main.once('camerafadeoutcomplete', () => {
    // 切換場景
    this.scene.start(newSceneKey);
  });
}
```

---

## 七、開發注意事項

### 7.1 性能優化
- 場景中精靈數量控制在 20 個以內
- 使用精靈池（Sprite Pool）管理角色
- 離開視野的精靈暫停更新

### 7.2 數據持久化
- 時間數據需要存檔
- 工作分配需要存檔
- 角色位置需要存檔

### 7.3 調試功能
```javascript
// 開發時的作弊功能
this.debugPanel = {
  skipTime: (hours) => {},      // 快進時間
  teleportEmployee: (id, x, y) => {},  // 傳送員工
  setWeather: (weather) => {},  // 改變天氣
  unlockAllEmployees: () => {}  // 解鎖所有員工
};
```

---

## 八、後續擴展方向

1. **多樓層系統**：二樓、三樓、地下室
2. **客人系統**：NPC 客人進入客棧，消費
3. **劇情事件**：角色背景故事解鎖
4. **小遊戲**：釣魚、採藥、打獵
5. **PVP 系統**：客棧 vs 客棧（？）

---

**文檔版本**：v1.0
**創建日期**：2025-10-24
**最後更新**：2025-10-24
